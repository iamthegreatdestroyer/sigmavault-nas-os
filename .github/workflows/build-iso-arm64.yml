name: Build ISO (ARM64)

on:
  push:
    branches: [main, develop]
    paths:
      - 'live-build/**'
      - 'packages/**'
      - 'src/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-packages:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ARM64 packages in container
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            debian:trixie \
            bash -c "
              apt-get update && \
              apt-get install -y build-essential devscripts debhelper dh-python python3-all python3-setuptools && \
              cd packages && \
              for pkg in */; do
                if [ -d \"\$pkg/debian\" ]; then
                  echo \"Building \$pkg...\"
                  cd \"\$pkg\"
                  dpkg-buildpackage -us -uc -b || true
                  cd ..
                fi
              done
            "
      
      - name: Upload packages
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-arm64
          path: packages/*.deb
          retention-days: 7

  build-iso:
    needs: build-packages
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Download packages
        uses: actions/download-artifact@v4
        with:
          name: deb-packages-arm64
          path: ./packages-arm64/
      
      - name: Build ARM64 ISO
        run: |
          docker run --rm --platform linux/arm64 \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            debian:trixie \
            bash -c "
              apt-get update && \
              apt-get install -y live-build cdebootstrap && \
              cp packages-arm64/*.deb live-build/config/packages.chroot/ 2>/dev/null || true && \
              cd live-build && \
              lb config --architectures arm64 && \
              lb build
            "
      
      - name: Upload ISO
        uses: actions/upload-artifact@v4
        with:
          name: sigmavault-nas-os-arm64
          path: live-build/*.iso
          retention-days: 30
